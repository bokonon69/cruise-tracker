<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>lloydkade live — publiek</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1320; color:#e7eefc; }
    .wrap { display:grid; grid-template-columns: 340px 1fr; gap:10px; height:100vh; padding:10px; box-sizing: border-box; }
    .panel { background:#111a2e; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; display:flex; flex-direction:column; }
    #map { border-radius:14px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .h { font-weight:700; margin-bottom:8px; }
    .muted { color:#9fb3d1; font-size:12px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    input, select, button { width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0d1a38; color:#e7eefc; padding:8px 10px; }
    button { background:#17335f; cursor:pointer; }
    .list { overflow:auto; margin-top:8px; display:grid; gap:8px; }
    .ship { background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; display:grid; grid-template-columns: 1fr auto; gap:6px; align-items:center; }
    .name { font-weight:600; }
    .chip { font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:#0d2247; color:#90caf9; }
    .status { font-size:12px; color:#9fb3d1; margin-top:6px; }
    .legend { display:flex; align-items:center; gap:8px; margin-top:8px; font-size:12px; color:#9fb3d1; }
    .bar { height:8px; width:140px; border-radius:6px; background: linear-gradient(90deg, #5e6c89 0%, #31a354 35%, #ffd54f 60%, #ff7043 85%, #ff1744 100%); }
    a { color:#90caf9; text-decoration:none; }
    .filters { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:8px; }
    .toggle { display:flex; align-items:center; gap:8px; font-size:13px; color:#cfe1ff; }
    .toggle input { width:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="h">lloydkade — publiek</div>
      <div class="muted">data via netlify function. api-key blijft server-side.</div>

      <label style="margin-top:8px;">update-interval (s)</label>
      <div class="row">
        <input id="interval" type="number" min="3" value="5" />
        <button id="btnStart">start</button>
      </div>

      <label style="margin-top:8px;">bbox-profiel</label>
      <div class="row">
        <select id="bboxProfile">
          <option value="smal">smal (lloydkade)</option>
          <option value="normaal" selected>normaal</option>
          <option value="ruim">ruim (rijnhaven↔maastunnel)</option>
        </select>
        <button id="btnRefresh">ververs</button>
      </div>

      <div class="filters">
        <label class="toggle"><input id="onlyPassengers" type="checkbox" /> alleen passagiers</label>
        <div class="legend"><div class="bar"></div><div>kleur = snelheid (kn)</div></div>
      </div>

      <div class="status" id="status">status: idle</div>
      <div class="list" id="list"></div>
    </div>
    <div id="map"></div>
  </div>

  <div id="toast" class="toast" style="display:none;"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    // bbox-profielen
    const profiles = {
      smal:   { minLat: 51.9038, maxLat: 51.9090, minLon: 4.4550, maxLon: 4.4720 },
      normaal:{ minLat: 51.9010, maxLat: 51.9120, minLon: 4.4400, maxLon: 4.4800 },
      ruim:   { minLat: 51.8985, maxLat: 51.9150, minLon: 4.4300, maxLon: 4.4950 }
    };
    let bbox = profiles.normaal;

    // kaart
    const map = L.map('map', { preferCanvas:true }).setView([51.9062, 4.4630], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    let bboxRect = L.rectangle([[bbox.minLat, bbox.minLon],[bbox.maxLat,bbox.maxLon]], {color:'#90caf9', weight:1, fillOpacity:.04}).addTo(map);

    // helpers
    const markers = new Map();

    function vesselFinderUrl(mmsi){ return `https://www.vesselfinder.com/vessels?mmsi=${encodeURIComponent(mmsi)}`; }

    // kleur op basis van snelheid: 0 kn -> grijsblauw, 3 kn -> groen, 8 kn -> geel, 15+ -> rood
    function sogColor(kn) {
      const v = Math.max(0, Math.min(15, Number.isFinite(kn) ? kn : 0)); // clamp 0..15
      if (v <= 0.3) return "#5e6c89";       // stil
      if (v <= 3)   return "#31a354";       // langzaam
      if (v <= 8)   return "#ffd54f";       // kruissnelheid
      if (v <= 15)  return "#ff7043";       // snel
      return "#ff1744";                     // heel snel (edge)
    }

    function isPassenger(type, name="") {
      const s = (type||"").toLowerCase();
      const n = (name||"").toLowerCase();
      return s.includes("pass") || s.includes("ferry") || /spido|waterbus|veer|ferry|passag/i.test(n);
    }

    function renderList(arr) {
      const el = document.getElementById('list');
      el.innerHTML='';
      arr.sort((a,b)=>(b.ts||0)-(a.ts||0)).forEach(s=>{
        const row = document.createElement('div');
        row.className='ship';
        const link = s.mmsi ? `<a target="_blank" href="${vesselFinderUrl(s.mmsi)}">detail</a>` : '';
        row.innerHTML = `<div><div class="name">${(s.name||'onbekend').trim()} <span class="chip">${s.mmsi||''}</span> ${link}</div>
          <div class="muted">${s.type||'type n.b.'} • koers ${s.cog!=null?Math.round(s.cog)+'°':'—'} • ${Number.isFinite(s.sog)?s.sog.toFixed(1)+' kn':'—'}</div></div>
          <div class="chip">${new Date(s.ts||Date.now()).toLocaleTimeString()}</div>`;
        el.appendChild(row);
      });
    }

    function upsertCircle(s) {
      const color = sogColor(s.sog);
      const opts = { radius: 6, color, fillColor: color, fillOpacity: 0.85, weight: 1 };
      let mk = markers.get(s.mmsi);
      if (!mk) {
        mk = L.circleMarker([s.lat, s.lon], opts).addTo(map);
        mk.bindPopup(`<b>${(s.name||'onbekend').trim()}</b><br>MMSI:${s.mmsi||'—'}<br>Type:${s.type||'—'}<br>SOG:${Number.isFinite(s.sog)?s.sog.toFixed(1)+' kn':'—'}<br>COG:${s.cog!=null?Math.round(s.cog)+'°':'—'}<br><a target="_blank" href="${vesselFinderUrl(s.mmsi)}">open in vesselfinder</a>`);
        markers.set(s.mmsi, mk);
      } else {
        mk.setLatLng([s.lat, s.lon]);
        mk.setStyle(opts);
      }
    }

    const lastSeen = new Set();
    function toast(msg) {
      let t = document.getElementById('toast');
      if (!t) { t = document.createElement('div'); t.id='toast'; t.className='toast'; document.body.appendChild(t); }
      t.textContent = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display='none', 3500);
    }

    function applyFilter(list) {
      const onlyPass = document.getElementById('onlyPassengers').checked;
      if (!onlyPass) return list;
      return list.filter(x => isPassenger(x.type, x.name));
    }

    // polling
    function apiUrl() {
      return `/.netlify/functions/ais-snapshot?minLat=${bbox.minLat}&maxLat=${bbox.maxLat}&minLon=${bbox.minLon}&maxLon=${bbox.maxLon}&windowMs=6000`;
    }

    let timer = null;
    async function fetchSnapshot() {
      const url = apiUrl();
      try {
        const t0 = performance.now();
        const r = await fetch(url, { cache:'no-store' });
        const json = await r.json();
        if (!json.ok) { document.getElementById('status').textContent = 'status: fout — ' + (json.error || r.status); return; }

        const filtered = applyFilter(json.data||[]);

        // binnenkomers
        const nowIds = new Set(filtered.map(s=>s.mmsi));
        filtered.forEach(s => { if (!lastSeen.has(s.mmsi)) toast(`nieuw schip: ${(s.name||s.mmsi).trim()}`); });
        lastSeen.clear(); nowIds.forEach(id => lastSeen.add(id));

        filtered.forEach(upsertCircle);
        renderList(filtered);

        const dt = (performance.now()-t0).toFixed(0);
        document.getElementById('status').textContent = `status: ${filtered.length}/${json.count} schepen • ${dt}ms`;
      } catch (e) {
        document.getElementById('status').textContent = 'status: netwerkfout';
      }
    }

    function setProfile(p){
      bbox = profiles[p] || profiles.normaal;
      if (bboxRect) map.removeLayer(bboxRect);
      bboxRect = L.rectangle([[bbox.minLat, bbox.minLon],[bbox.maxLat,bbox.maxLon]], {color:'#90caf9', weight:1, fillOpacity:.04}).addTo(map);
      map.invalidateSize();
      fetchSnapshot();
    }

    document.getElementById('btnStart').addEventListener('click', ()=>{
      const secs = Math.max(3, parseInt(document.getElementById('interval').value||'5',10));
      if (timer) clearInterval(timer);
      fetchSnapshot();
      timer = setInterval(fetchSnapshot, secs*1000);
      document.getElementById('status').textContent = 'status: polling gestart';
      map.invalidateSize();
    });
    document.getElementById('btnRefresh').addEventListener('click', ()=> setProfile(document.getElementById('bboxProfile').value));
    document.getElementById('onlyPassengers').addEventListener('change', ()=> fetchSnapshot());

    setProfile('normaal');
  </script>
</body>
</html>
