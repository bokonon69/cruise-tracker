<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>lloydkade live — publiek</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#0b1320; color:#e7eefc; }
    .wrap { display:grid; grid-template-columns: 320px 1fr; gap:10px; height:100vh; padding:10px; box-sizing: border-box; }
    .panel { background:#111a2e; border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:12px; display:flex; flex-direction:column; }
    #map { border-radius:14px; overflow:hidden; box-shadow: 0 10px 30px rgba(0,0,0,.35); }
    .h { font-weight:700; margin-bottom:8px; }
    .muted { color:#9fb3d1; font-size:12px; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    input, select, button { width:100%; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0d1a38; color:#e7eefc; padding:8px 10px; }
    button { background:#17335f; cursor:pointer; }
    .list { overflow:auto; margin-top:8px; display:grid; gap:8px; }
    .ship { background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; display:grid; grid-template-columns: 1fr auto; gap:6px; align-items:center; }
    .name { font-weight:600; }
    .chip { font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:#0d2247; color:#90caf9; }
    .status { font-size:12px; color:#9fb3d1; margin-top:6px; }
    .toast { position: fixed; right: 16px; bottom: 16px; background: #10203f; border:1px solid rgba(255,255,255,.12); color:#e7eefc; padding:10px 12px; border-radius:10px; }
    a { color:#90caf9; text-decoration:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="h">lloydkade — publiek</div>
      <div class="muted">data via netlify function. api-key blijft server-side.</div>

      <label style="margin-top:8px;">update-interval (s)</label>
      <div class="row">
        <input id="interval" type="number" min="3" value="5" />
        <button id="btnStart">start</button>
      </div>

      <label style="margin-top:8px;">bbox-profiel</label>
      <div class="row">
        <select id="bboxProfile">
          <option value="smal">smal (lloydkade)</option>
          <option value="normaal" selected>normaal</option>
          <option value="ruim">ruim (rijnhaven↔maastunnel)</option>
        </select>
        <button id="btnRefresh">ververs</button>
      </div>

      <div class="status" id="status">status: idle</div>
      <div class="list" id="list"></div>
    </div>
    <div id="map"></div>
  </div>

  <div id="toast" class="toast" style="display:none;"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script>
    const profiles = {
      smal:   { minLat: 51.9038, maxLat: 51.9090, minLon: 4.4550, maxLon: 4.4720 },
      normaal:{ minLat: 51.9010, maxLat: 51.9120, minLon: 4.4400, maxLon: 4.4800 },
      ruim:   { minLat: 51.8985, maxLat: 51.9150, minLon: 4.4300, maxLon: 4.4950 }
    };
    let bbox = profiles.normaal;

    const map = L.map('map', { preferCanvas:true }).setView([51.9062, 4.4630], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
    let bboxRect = L.rectangle([[bbox.minLat, bbox.minLon],[bbox.maxLat,bbox.maxLon]], {color:'#90caf9', weight:1, fillOpacity:.04}).addTo(map);

    const markers = new Map();
    function makeIcon(color = '#90caf9', rotationDeg = 0) {
      const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'><polygon points='12,2 22,22 2,22' fill='${color}' opacity='0.9' /></svg>`);
      return L.divIcon({ className: 'ship-icon', html: `<img src="data:image/svg+xml;utf8,${svg}" style="transform: rotate(${rotationDeg}deg); width:22px; height:22px;">`, iconSize:[22,22], iconAnchor:[11,11]});
    }
    const typeColor = (t) => {
      const s = (t||'').toString().toLowerCase();
      if (s.includes('tanker') || s.includes('89') || s.includes('80')) return '#ff7043';
      if (s.includes('passeng') || s.includes('69') || s.includes('60')) return '#ffd54f';
      if (s.includes('cargo') || s.includes('79') || s.includes('70')) return '#8bc34a';
      return '#90caf9';
    };

    function vesselFinderUrl(mmsi){ return `https://www.vesselfinder.com/vessels?mmsi=${encodeURIComponent(mmsi)}`; }

    function renderList(arr) {
      const el = document.getElementById('list');
      el.innerHTML='';
      arr.sort((a,b)=>(b.ts||0)-(a.ts||0)).forEach(s=>{
        const row = document.createElement('div');
        row.className='ship';
        const link = s.mmsi ? `<a target="_blank" href="${vesselFinderUrl(s.mmsi)}">detail</a>` : '';
        row.innerHTML = `<div><div class="name">${s.name || 'onbekend'} <span class="chip">${s.mmsi||''}</span> ${link}</div>
          <div class="muted">${s.type||'type n.b.'} • koers ${s.cog!=null?Math.round(s.cog)+'°':'—'} • ${s.sog!=null?s.sog.toFixed(1)+' kn':'—'}</div></div>
          <div class="chip">${new Date(s.ts||Date.now()).toLocaleTimeString()}</div>`;
        el.appendChild(row);
      });
    }

    function upsert(s) {
      const color = typeColor(s.type);
      const icon = makeIcon(color, (s.cog||0));
      let mk = markers.get(s.mmsi);
      if (!mk) {
        mk = L.marker([s.lat, s.lon], { icon }).addTo(map);
        mk.bindPopup(`<b>${s.name||'onbekend'}</b><br>MMSI:${s.mmsi||'—'}<br>Type:${s.type||'—'}<br>SOG:${s.sog!=null?s.sog.toFixed(1)+' kn':'—'}<br>COG:${s.cog!=null?Math.round(s.cog)+'°':'—'}<br><a target="_blank" href="${vesselFinderUrl(s.mmsi)}">open in vesselfinder</a>`);
        markers.set(s.mmsi, mk);
      } else {
        mk.setLatLng([s.lat, s.lon]);
        mk.setIcon(icon);
      }
    }

    const lastSeen = new Set();
    function toast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.style.display = 'block';
      setTimeout(()=> t.style.display='none', 3500);
    }

    let timer = null;
    function apiUrl() {
      return `/.netlify/functions/ais-snapshot?minLat=${bbox.minLat}&maxLat=${bbox.maxLat}&minLon=${bbox.minLon}&maxLon=${bbox.maxLon}&windowMs=6000`;
    }
    async function fetchSnapshot() {
      const url = apiUrl();
      try {
        const t0 = performance.now();
        const r = await fetch(url, { cache:'no-store' });
        const json = await r.json();
        if (!json.ok) { document.getElementById('status').textContent = 'status: fout — ' + (json.error || r.status); return; }
        const nowIds = new Set((json.data||[]).map(s=>s.mmsi));
        (json.data||[]).forEach(s => { if (!lastSeen.has(s.mmsi)) toast(`nieuw schip: ${s.name || s.mmsi}`); });
        lastSeen.clear(); nowIds.forEach(id => lastSeen.add(id));
        (json.data||[]).forEach(upsert);
        renderList(json.data||[]);
        document.getElementById('status').textContent = `status: ${json.count} schepen • ${(performance.now()-t0).toFixed(0)}ms`;
      } catch {
        document.getElementById('status').textContent = 'status: netwerkfout';
      }
    }

    function setProfile(p){
      bbox = profiles[p] || profiles.normaal;
      if (bboxRect) map.removeLayer(bboxRect);
      bboxRect = L.rectangle([[bbox.minLat, bbox.minLon],[bbox.maxLat,bbox.maxLon]], {color:'#90caf9', weight:1, fillOpacity:.04}).addTo(map);
      fetchSnapshot();
    }

    document.getElementById('btnStart').addEventListener('click', ()=>{
      const secs = Math.max(3, parseInt(document.getElementById('interval').value||'5',10));
      if (timer) clearInterval(timer);
      fetchSnapshot();
      timer = setInterval(fetchSnapshot, secs*1000);
      document.getElementById('status').textContent = 'status: polling gestart';
    });
    document.getElementById('btnRefresh').addEventListener('click', ()=> setProfile(document.getElementById('bboxProfile').value));
    setProfile('normaal');
  </script>
</body>
</html>
